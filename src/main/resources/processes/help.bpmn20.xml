<?xml version="1.0" encoding="UTF-8"?>
<definitions
        xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:activiti="http://activiti.org/bpmn"
        targetNamespace="Examples">

    <process id="help" name="help" isExecutable="true">
        <startEvent id="startHelp"/>
        <sequenceFlow sourceRef="startHelp" targetRef="setupInitOptions"/>
        <serviceTask id="setupInitOptions"
                     activiti:expression="#{bot.sendOptions(execution, chatId, 'К чему относится ваша проблема?', 'initAnswer', 'vsp', 'Обслуживание в отделении', 'terminal', 'Банкоматы', 'cards', 'Карты', 'bonuses', 'Бонусы', 'cabinet', 'Личный кабинет')}"/>
        <sequenceFlow sourceRef="setupInitOptions" targetRef="selectInitialOption"/>
        <userTask id="selectInitialOption" />
        <sequenceFlow sourceRef="selectInitialOption" targetRef="initialOptionSelected"/>
        <exclusiveGateway id="initialOptionSelected"/>
        <sequenceFlow sourceRef="initialOptionSelected" targetRef="setupVspOptions">
            <conditionExpression xsi:type="tFormalExpression">#{initAnswer == "vsp"}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="initialOptionSelected" targetRef="enterTerminalNumber">
            <conditionExpression xsi:type="tFormalExpression">#{initAnswer == "terminal"}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="initialOptionSelected" targetRef="setupInitOptions">
            <conditionExpression xsi:type="tFormalExpression">
                #{!initAnswerOptions.containsKey(initAnswer)}
            </conditionExpression>
        </sequenceFlow>
        
        <serviceTask id="setupVspOptions"
                     activiti:expression="#{bot.sendOptions(execution, chatId, 'Уточнение отделения', 'vspChoose', 'vspNumber', '№ отделения', 'address', 'Адрес отделения', 'geolocation', 'Геопозиция')}"/>
        <sequenceFlow sourceRef="setupVspOptions" targetRef="selectVspOption"/>
        <userTask id="selectVspOption" />
        <sequenceFlow sourceRef="selectVspOption" targetRef="vspOptionSelected"/>
        <exclusiveGateway id="vspOptionSelected"/>
        <sequenceFlow sourceRef="vspOptionSelected" targetRef="vspChooseLocation">
            <conditionExpression xsi:type="tFormalExpression">#{vspChoose == "geolocation"}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="vspOptionSelected" targetRef="setupVspOptions">
            <conditionExpression xsi:type="tFormalExpression">
                #{!vspChooseOptions.containsKey(vspChoose)}
            </conditionExpression>
        </sequenceFlow>
        <serviceTask id="vspChooseLocation"
                     activiti:expression="#{bot.requestLocation(chatId, 'Укажите локацию', 'geolocation')}"/>
        <sequenceFlow sourceRef="vspChooseLocation" targetRef="endHelp"/>
        
        <serviceTask id="enterTerminalNumber"
                     activiti:expression="#{bot.requestString(chatId, 'Введите номер банкомата', 'terminalNumber')}"/>
        <sequenceFlow sourceRef="enterTerminalNumberTask" targetRef="enterTerminalNumberTask"/>
        <userTask id="enterTerminalNumberTask" />
        <sequenceFlow sourceRef="enterTerminalNumberTask" targetRef="endHelp"/>
        <serviceTask id="setupTerminalOptions"
                     activiti:expression="#{bot.sendOptions(execution, chatId, 'Уточните тип проблемы', 'terminalProblem', 'card', 'Забрал карту', 'noMoney', 'Отсутствуют деньги', 'noSaved', 'Деньги не зачислены на карту', 'pause', 'Завис', 'another', 'Другая проблема')}"/>
        <sequenceFlow sourceRef="setupTerminalOptions" targetRef="selectTerminalOptions"/>
        <userTask id="selectTerminalOptions" />
        <sequenceFlow sourceRef="selectInitialOption" targetRef="terminalOptionSelected"/>
        <exclusiveGateway id="terminalOptionSelected"/>

        <sequenceFlow sourceRef="terminalOptionSelected" targetRef="createRequest">
            <conditionExpression xsi:type="tFormalExpression">#{terminalProblem == "card"}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="terminalOptionSelected" targetRef="enterComment">
            <conditionExpression xsi:type="tFormalExpression">#{terminalProblem == "another"}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="terminalOptionSelected" targetRef="terminalOptionSelected">
            <conditionExpression xsi:type="tFormalExpression">
                #{!terminalProblemOptions.containsKey(terminalProblem)}
            </conditionExpression>
        </sequenceFlow>

        <serviceTask id="enterComment"
                     activiti:expression="#{bot.requestString(chatId, 'Введите номер банкомата', 'terminalNumber')}"/>
        <sequenceFlow sourceRef="enterComment" targetRef="enterCommentTask"/>
        <userTask id="enterCommentTask" />
        <sequenceFlow sourceRef="enterCommentTask" targetRef="endHelp"/>

        <serviceTask id="createRequest"
                     activiti:expression="#{bot.assignRequest(chatId)}"/>
        <sequenceFlow sourceRef="createRequest" targetRef="endHelp"/>

        <endEvent id="endHelp"/>
    </process>

</definitions>